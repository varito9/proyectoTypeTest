# Fichero: docker-compose.dev.yml
# Descripción: Entorno de desarrollo con hot-reloading para frontend, backend, MongoDB y MySQL.
# Uso: docker compose -f docker-compose.dev.yml up --build

services:
  # Servicio del frontend (Vue.js/Vite)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: trr-frontend-dev
    environment:
      VITE_NODE_ENV: development
      CHOKIDAR_USEPOLLING: "true"
    ports:
      - "5174:5174" # Puerto de desarrollo de Vite.
    # Monta el código fuente para hot-reloading (asumiendo que tu código está en ./frontend dentro del contexto de build).
    volumes:
      - ./frontend:/app
      # Volumen anónimo para node_modules, crucial para hot-reloading:
      - /app/node_modules
    # Usas env_file, lo mantenemos:
    env_file:
      - ./frontend/.env
    # El comando para desarrollo debe ser configurado para correr Vite/Webpack dev server:
    command: npm run dev
    networks:
      - trr-net

  # Servicio del backend (Node.js/Express)
  backend:
    build: ./backend
    container_name: trr-backend-dev
    environment:
      NODE_ENV: development
      # DB_HOST debe apuntar al nombre del servicio Docker (manteniendo tu puerto 3001)
      DB_HOST: mysql
    ports:
      - "3001:3001"
    # Monta el código fuente para hot-reloading (nodemon/webpack-dev-server):
    volumes:
      - ./backend:/app
      # Volumen anónimo para node_modules:
      - /app/node_modules
    env_file:
      - ./backend/.env
    # Comando para iniciar el servidor en modo desarrollo con nodemon.
    command: npx nodemon server.js
    depends_on:
      mongo:
        condition: service_started
      mysql:
        condition: service_healthy
    networks:
      - trr-net

  # Servicio de la base de datos MongoDB
  mongo:
    image: mongo:latest
    container_name: trr-mongo-dev
    ports:
      - "27017:27017" # Acceso desde el host
    volumes:
      - mongo-data:/data/db # Persistencia de datos
    networks:
      - trr-net

  # Servicio de la base de datos MySQL
  mysql:
    image: mysql:8.0
    container_name: trr-mysql-dev
    ports:
      - "3307:3306" # Acceso desde el host (cambiado a 3307 para evitar conflictos)
    environment:
      # Variables de desarrollo HARDCODEADAS (como en tu ejemplo), cámbialas si es necesario.
      MYSQL_ROOT_PASSWORD: root_password_dev
      MYSQL_DATABASE: trr_db_dev
      MYSQL_USER: trr_user_dev
      MYSQL_PASSWORD: trr_password_dev
    volumes:
      - mysql-data:/var/lib/mysql # Persistencia de datos
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - trr-net

  # Servicio Adminer para administración rápida de bases de datos (MySQL)
  adminer:
    image: adminer:latest
    container_name: trr-adminer-dev
    restart: always
    ports:
      - "8088:8080" # Exponer Adminer en el host en el puerto 8088
    depends_on:
      - mysql
    networks:
      - trr-net

# Definición de la red (manteniendo tu nombre)
networks:
  trr-net:
    driver: bridge

# Definición de los volúmenes para la persistencia de datos
volumes:
  mongo-data:
  mysql-data:
